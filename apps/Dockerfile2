ARG IMAGE_VERSION="3.9-slim-bullseye"

# ============================================================
FROM python:${IMAGE_VERSION} as builder

USER root

ARG PIP_EXTRA_INDEX_URL

# Add Tini
ENV TINI_VERSION v0.19.0
ADD https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /tini

COPY ./requirements /tmp/src/requirements

RUN python -m venv /opt/es-psd2 \
 && opt/es-psd2/bin/pip install --no-cache-dir --upgrade pip setuptools wheel  \
 && opt/es-psd2/bin/pip install --no-cache-dir gunicorn==20.1.0 \
 && opt/es-psd2/bin/pip install --no-cache-dir -r /tmp/src/requirements/prod \
 ;

COPY . /tmp/src

RUN /opt/es-psd2/bin/pip install --no-cache-dir /tmp/src

# ============================================================
FROM python:${IMAGE_VERSION}

# Copy tini and the pyhton package into /opt from the builder image
COPY --from=builder /opt/es-psd2 /opt/es-psd2
COPY --from=builder /tini /tini
# We do not use the COPY --chown:user option in the step above because it does not support env vars
RUN chmod +x /tini \
    ;

ENV PATH="/opt/es-psd2/bin:${PATH}"

ENTRYPOINT ["/tini", "-g", "--"]

CMD ["sh", "-c", "gunicorn es_psd2.app:app --workers ${WORKER:-$ES_PSD2_WORKER} --worker-class uvicorn.workers.UvicornWorker --bind $ES_PSD2_HOST:${PORT:-$ES_PSD2_PORT} --timeout 0"]
